$(function(){sjcl.random.startCollectors(),loginForm.init(),InfoPanel.init()});var loginForm={accountName:$("#accountName"),body:$("body"),alertCookie:$("#cookie-check"),alertHolder:$("#display-errors"),alertJsHolder:$("#js-errors"),csrfToken:$("#csrftoken"),password:null,passwordForm:$("#password-form"),passwordFill:".",submitButton:$("#submit"),srpClientSession:null,srpClientCredentials:null,inputPassword:$("#password"),inputUseSrp:$("#useSrp"),inputPublicA:$("#publicA"),inputClientEvidenceM1:$("#clientEvidenceM1"),networkErrorMessage:null,preventDefault:function(e){e.preventDefault()},init:function(){this.checkCookie(),this.setFocus(),this.setSrpAjaxCall(),this.setCaptcha(loginForm.passwordForm)},setSrpAjaxCall:function(){this.submitButton.bind("click",this.preventDefault).click(function(){try{loginForm.getSrpData()}catch(e){setTimeout(function(){loginForm.submitButton.removeAttr("disabled").unbind("click").click()})}})},checkCookie:function(){var e=navigator.cookieEnabled;e||($(loginForm.alertCookie).removeClass("hide"),$(loginForm.alertJsHolder).removeClass("hide"))},setFocus:function(){loginForm.body.hasClass("mobile")||(loginForm.accountName.val()?loginForm.inputPassword.focus():loginForm.accountName.focus())},setCaptcha:function(e){e.hasClass("captcha-required")&&$("#captcha-anchor").click(function(e){e.preventDefault(),$("#sec-string").attr("src","/login/captcha.jpg?"+(new Date).getTime())})},getSrpData:function(){var e=loginForm.passwordForm.find('input[name="accountName"]').val();$.ajax({method:"POST",url:"/login/srp?csrfToken=true",data:JSON.stringify({inputs:[{input_id:"account_name",value:e}]}),dataType:"json",beforeSend:function(e){e.setRequestHeader("Accept","application/json"),e.setRequestHeader("Content-Type","application/json")}}).done(function(e){loginForm.onSuccess(e),loginForm.submitButton.removeAttr("disabled").unbind("click").click()}).fail(function(e){loginForm.onFail(e)}).complete(function(e){loginForm.onComplete(e)})},onSuccess:function(e){loginForm.csrfToken.val(e.csrf_token),this.password=this.inputPassword.val(),this.srpClientSession=new SrpClientSession(e.modulus,e.generator,e.hash_function),this.srpClientCredentials=this.srpClientSession.step1(e.username,this.password,e.salt,e.public_B),null!==this.password&&this.inputPassword.val(Array(this.password.length+1).join(this.passwordFill)),this.inputUseSrp.val("true"),this.inputPublicA.val(this.srpClientCredentials.publicA.toString(16)),this.inputClientEvidenceM1.val(this.srpClientCredentials.clientEvidenceM1.toString(16))},onFail:function(e){if(navigator.onLine)var t=JSON.parse(e.responseText),i=t.error_code,n=t.support_error_code,o=t.error_message;else var i="NETWORK_ERROR",n="",o=loginForm.networkErrorMessage;loginForm.alertHolder.length&&loginForm.alertHolder.remove(),loginForm.alertJsHolder.html(o).removeClass("hide"),this.inputPassword.val(""),loginForm.submitButton.button("reset"),EmbeddedLogin.errorHandlerRegistration&&EmbeddedLogin.errorHandlerRegistration(i,n,o)},onComplete:function(e){var t=/^([a-zA-Z0-9_.-])+@(([a-zA-Z0-9-])+.)+([a-zA-Z0-9]{2,4})+$/;!t.test(e.username)&&$("body").hasClass("mobile")&&loginForm.submitButton.button("reset")}},InfoPanel={cssHide:"hide",cssShow:"show",cssGrid:"info-active",leftPanel:"#info-wrapper",rightPanel:"#login-wrapper",phoneInfoToggle:"#info-phone-toggle",phoneInfoClose:"#info-phone-close",title:null,body:null,enabled:null,domReady:!1,init:function(){this.domReady=!0,this.$leftPanel=$(this.leftPanel),this.$rightPanel=$(this.rightPanel),this.$mobileToggle=$(this.phoneInfoToggle),this.$mobileClose=$(this.phoneInfoClose),this.enabled&&this.toggle(this.enabled,this.title,this.body),this.enableMobile()},toggle:function(e,t,i){this.title=t,this.body=i,this.enabled=e;var n="InfoPanel.toggle called.";return this.domReady&&(e?(this.$leftPanel.find(".info-title").html(t),this.$leftPanel.find(".info-body").html(i),this.$mobileToggle.html(t),this.$leftPanel.removeClass(this.cssHide),this.$rightPanel.addClass(this.cssGrid),this.$mobileToggle.removeClass(this.cssHide)):(this.$leftPanel.addClass(this.cssHide),this.$rightPanel.removeClass(this.cssGrid),this.$mobileToggle.addClass(this.cssHide)),n+="Dom ready."),n},enableMobile:function(){var e=this,t=function(e,t,i){e.stopPropagation(),e.preventDefault(),t.removeClass(InfoPanel.cssHide),i.addClass(InfoPanel.cssHide)};this.$mobileToggle.on("click",function(i){t(i,e.$leftPanel,e.$rightPanel)}),this.$mobileClose.on("click",function(i){t(i,e.$rightPanel,e.$leftPanel)})}},EmbeddedLogin={inputAccountName:null,inputPassword:null,inputPersistLogin:$("#persistLogin"),inputAccountNameId:"accountName",inputPasswordId:"password",errorContainer:null,errorContainerId:"#display-errors",jsErrorContainer:null,jsErrorContainerId:"#js-errors",errorHandlerRegistration:null,init:function(){return this.inputAccountName=document.getElementById(this.inputAccountNameId),this.inputPassword=document.getElementById(this.inputPasswordId),this.errorContainer=$(this.errorContainerId),this.jsErrorContainer=$(this.jsErrorContainerId),this},fillAccountName:function(e){return this.inputAccountName.value=e,this},fillPassword:function(e){return this.inputPassword.value=e,this},setPersistLogin:function(e){this.inputPersistLogin&&this.inputPersistLogin.prop("checked",e)},registerErrorHandler:function(e){this.errorHandlerRegistration=e}};